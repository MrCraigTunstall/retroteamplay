CreateConVar("hud_deathnotice_time", "6", FCVAR_REPLICATED)

killicon.AddFont("prop_physics", "HL2MPTypeDeath", "9", color_white)
killicon.AddFont("prop_physics_multiplayer", "HL2MPTypeDeath", "9", color_white)
killicon.AddFont("weapon_assassinknife", "teamplaydeathnoticecs", "j", color_white)

killicon.Add("dummy_bloodboil", "spellicons/bloodpact.png", color_white)
killicon.Add("dummy_burn", "spellicons/burn.png", color_white)
killicon.Add("dummy_death", "spellicons/death.png", color_white)
killicon.Add("dummy_divinebolt", "spellicons/divinebolt.png", color_white)
killicon.Add("dummy_eruption", "spellicons/meteorshards.png", color_white)
killicon.Add("dummy_firecloud", "spellicons/toxiccloud.png", color_white)
killicon.Add("dummy_flamestrike", "spellicons/explosion.png", color_white)
killicon.Add("dummy_lightning", "spellicons/lightning.png", color_white)
killicon.Add("dummy_shock", "spellicons/shock.png", color_white)
killicon.Add("dummy_shocknaut", "spellicons/dreadnaut.png", color_white)
killicon.Add("dummy_sunbeam", "spellicons/sunbeam.png", color_white)
killicon.Add("geyser", "spellicons/geyser.png", color_white)
killicon.Add("initiate", "spellicons/initiate.png", color_white)
killicon.Add("jolt", "spellicons/jolt.png", color_white)
killicon.Add("holynova", "spellicons/holynova.png", color_white)
killicon.Add("player", "spellicons/death.png", color_white)
killicon.Add("poisonrain", "spellicons/acidrain.png", color_white)
killicon.Add("projectile_blackholesun", "spellicons/blackholesun.png", color_white)
killicon.Add("projectile_bouncerarrow", "spellicons/bouncerbullet.png", color_white)
killicon.Add("projectile_comet", "spellicons/meteor.png", color_white)
killicon.Add("projectile_detonatorarrow", "spellicons/russianroulette.png", color_white)
killicon.Add("projectile_dragoonfireball", "spellicons/dragoonfireball.png", color_white)
killicon.Add("projectile_electronball", "spellicons/obliteration.png", color_white)
killicon.Add("projectile_firearrow", "spellicons/firebullet.png", color_white)
killicon.Add("projectile_firebolt", "spellicons/fireball.png", color_white)
killicon.Add("projectile_firebomb", "spellicons/starburst.png", color_white)
killicon.Add("projectile_firesprite", "spellicons/firesprites.png", color_white)
killicon.Add("projectile_flamespiral", "spellicons/flamespiral.png", color_white)
killicon.Add("projectile_flamethrower", "spellicons/flamethrower.png", color_white)
killicon.Add("projectile_flare", "spellicons/flare.png", color_white)
killicon.Add("projectile_forceofnature", "spellicons/forceofnature.png", color_white)
killicon.Add("projectile_forceofnaturefragment", "spellicons/forceofnature.png", color_white)
killicon.Add("projectile_harpoon", "spellicons/harpoon.png", color_white)
killicon.Add("projectile_hydropump", "spellicons/hydropump.png", color_white)
killicon.Add("projectile_icemineprotrusion", "spellicons/protrusion.png", color_white)
killicon.Add("projectile_icespear", "spellicons/icespear.png", color_white)
killicon.Add("projectile_lightningarrow", "spellicons/lightningbullet.png", color_white)
killicon.Add("projectile_magicarrow", "spellicons/moonglow.png", color_white)
killicon.Add("projectile_magicmissile", "spellicons/missilesofmagic.png", color_white)
killicon.Add("projectile_meteor", "spellicons/meteor.png", color_white)
killicon.Add("projectile_napalmbomb", "spellicons/firebomb.png", color_white)
killicon.Add("projectile_pixie", "spellicons/pixieswarm.png", color_white)
killicon.Add("projectile_plasmabolt", "spellicons/plasma.png", color_white)
killicon.Add("projectile_protometeor", "spellicons/protometeor.png", color_white)
killicon.Add("projectile_protrusionspike", "spellicons/protrusion.png", color_white)
killicon.Add("projectile_scatterfrost", "spellicons/scatterfrost.png", color_white)
killicon.Add("projectile_scatterfrostbolt", "spellicons/scatterfrost.png", color_white)
killicon.Add("projectile_scepter", "spellicons/bubble.png", color_white)
killicon.Add("projectile_scorch", "spellicons/scorch.png", color_white)
killicon.Add("projectile_shockwave", "spellicons/smite.png", color_white)
killicon.Add("projectile_sparkler", "spellicons/sparkler.png", color_white)
killicon.Add("projectile_spritearrow", "spellicons/magicbullet.png", color_white)
killicon.Add("projectile_starburstbolt", "spellicons/starburst3.png", color_white)
killicon.Add("projectile_starburstfrost", "spellicons/starburst3.png", color_white)
killicon.Add("projectile_staticball", "spellicons/staticball.png", color_white)
killicon.Add("projectile_vampiricarrow", "spellicons/vampiricbullet.png", color_white)
killicon.Add("projectile_volcanicblast", "spellicons/volcanicblast.png", color_white)
killicon.Add("projectile_zolt", "spellicons/zolt.png", color_white)
killicon.Add("status_berserkercharge", "spellicons/berserkercharge.png", color_white)
killicon.Add("status_burn", "spellicons/flickerflame.png", color_white)
killicon.Add("status_channelingearthquake", "spellicons/earthquake.png", color_white)
killicon.Add("status_channelingmeltdown", "spellicons/firebomb.png", color_white)
killicon.Add("status_energybolt", "spellicons/energybolt.png", color_white)
killicon.Add("status_explosion", "spellicons/flamestrike.png", color_white)
killicon.Add("status_whirlwind", "spellicons/whirlwind.png", color_white)
killicon.Add("status_sacredvow", "spellicons/sacredvow.png", color_white)
killicon.Add("status_venom", "spellicons/venomblade.png", color_white)
killicon.Add("suicide", "spellicons/death.png", color_white)
killicon.Add("toxiccloud", "spellicons/toxiccloud.png", color_white)
killicon.Add("typhoon", "spellicons/typhoon.png", color_white)
killicon.Add("vehicle_noxbase", "spellicons/vehicle_noxbase.png", color_white)
killicon.Add("vehicle_noxdropship", "spellicons/vehicle_noxdropship.png", color_white)
killicon.Add("vehicle_noxhovercycle", "spellicons/vehicle_noxhovercycle3.png", color_white)
killicon.Add("vehicle_noxraven", "spellicons/vehicle_noxraven.png", color_white)
killicon.Add("vehicle_noxvulture", "spellicons/vehicle_noxvulture.png", color_white)
killicon.Add("vehicle_noxwasp", "spellicons/vehicle_noxwasp.png", color_white)
killicon.Add("worldspawn", "spellicons/death.png", color_white)
killicon.Add("dummy_arcaneexplosion", "spellicons/flamestrike.png", color_white)
killicon.Add("dummy_soulexplosion", "spellicons/fear.png", color_white)
killicon.Add("dummy_powerwell", "spellicons/powerwell.png", color_white)
killicon.Add("npc_antlionguard", "spellicons/leap.png", color_white)
killicon.Add("projectile_swordthrow", "spellicons/swordthrow.png", color_white)
killicon.Add("projectile_blade_spirit", "spellicons/bladespirit.png", color_white)
killicon.Add("status_stormblade_arc", "spellicons/stormblade.png", color_white)
killicon.Add("status_flameblade_burn", "spellicons/flameblade.png", color_white)
killicon.Add("status_frostblade_freeze", "spellicons/frostblade.png", color_white)
killicon.Add("projectile_fist", "spellicons/fistofvengeance.png", color_white)
killicon.Add("projectile_volleyarrow", "spellicons/russianroulette.png", color_white)
killicon.Add("projectile_volleyarrowbolt", "spellicons/russianroulette.png", color_white)
killicon.Add("projectile_wrench", "spellicons/crafter.png", color_white)
killicon.Add("status_leap", "spellicons/leap2.png", color_white)
killicon.Add("netherbomb", "spellicons/evade.png", color_white)
killicon.Add("weapon_zombie", "spellicons/summonzombie.png", color_white)
killicon.Add("projectile_zombieflesh", "spellicons/summonzombie.png", color_white)
killicon.Add("projectile_discharge", "spellicons/jolt.png", color_white)


killicon.AddAlias("env_fire", "dummy_burn")
killicon.AddAlias("projectile_assaultrovercannon", "vehicle_noxbase")
killicon.AddAlias("projectile_dreadnautmissile", "projectile_volcaniclast")
killicon.AddAlias("projectile_dropshipcannon", "vehicle_noxdropship")
killicon.AddAlias("projectile_dropshipmissile", "vehicle_noxdropship")
killicon.AddAlias("projectile_manashardbomb", "initiate")
killicon.AddAlias("projectile_plasma_mountablecannon", "projectile_plasmabolt")
killicon.AddAlias("projectile_plasmabolt_hovercycle", "vehicle_noxhovercycle")
killicon.AddAlias("projectile_ravenmissile", "vehicle_noxraven")
killicon.AddAlias("projectile_vulturebomb", "vehicle_noxvulture")

language.Add("trigger_hurt_nox", "Environment")

usermessage.Hook("PlayerKilledByPlayers", function(message)
	local victim = message:ReadEntity()
	local inflictor = message:ReadString()
	local attacker = message:ReadEntity()
	local attacker2 = message:ReadEntity()

	if victim:IsValid() and attacker:IsValid() and attacker2:IsValid() then
		local attackername = attacker:Name()
		local victimname = victim:Name()
		local attacker2name = attacker2:Name()
		GAMEMODE:AddDeathNotice(attackername, attacker:Team(), attacker2name, attacker2:Team(), inflictor, victimname, victim:Team())
		print(attackername.." killed "..victimname.." with assistance from "..attacker2name.." with "..inflictor)
	end
end)

usermessage.Hook("PlayerKilledByPlayer", function(message)
	local victim = message:ReadEntity()
	local inflictor = message:ReadString()
	local attacker = message:ReadEntity()

	if victim:IsValid() and attacker:IsValid() then
		local attackername = attacker:Name()
		local victimname = victim:Name()
		GAMEMODE:AddDeathNotice(attackername, attacker:Team(), nil, nil, inflictor, victimname, victim:Team())
		print(attackername.." killed "..victimname.." with "..inflictor)
	end
end)

usermessage.Hook("PlayerKilledSelf", function(message)
	local victim = message:ReadEntity()
	local inflictor = message:ReadString()

	if victim:IsValid() then
		GAMEMODE:AddDeathNotice(nil, nil, nil, nil, inflictor, victim:Name(), victim:Team())
		print(victim:Name().." killed themself with "..inflictor)
	end
end)

usermessage.Hook("PlayerKilled", function(message)
	local victim = message:ReadEntity()
	local inflictor = message:ReadString()
	local attacker = "#"..message:ReadString()

	if victim:IsValid() then
		GAMEMODE:AddDeathNotice(attacker, -1, nil, nil, inflictor, victim:Name(), victim:Team())
		print(victim:Name().." was killed by "..inflictor)
	end
end)

local Deaths = {}

function GM:AddDeathNotice(leftstring, leftteam, assiststring, assistteam, inflictorstring, rightstring, rightteam)
	local Death = {time = RealTime() + GetConVarNumber("hud_deathnotice_time"),
	left = leftstring,
	right = rightstring,
	assist = assiststring,
	icon = inflictorstring}

	if leftteam == -1 then Death.leftcolor = color_white
	else Death.leftcolor = team.GetColor(leftteam) end

	if assistteam == -1 then Death.assistcolor = color_white
	else Death.assistcolor = team.GetColor(assistteam) end

	if rightteam == -1 then Death.rightcolor = color_white
	else Death.rightcolor = team.GetColor(rightteam) end

	if Death.left == Death.right then
		Death.left = nil
		Death.icon = "suicide"
	end

	if #Deaths > 6 then
		table.remove(Deaths, 1)
	end

	table.insert(Deaths, Death)
end

local function DrawDeath(x, y, death)
	local w, h = killicon.GetSize(death.icon)

	killicon.Draw(x, y, death.icon, 255)

	if death.assist then
		surface.SetFont("ChatFont")
		local texw, texh = surface.GetTextSize(death.assist)
		local subx = x - w * 0.5 - 16
		draw.SimpleText(death.assist, "ChatFont", subx, y, death.assistcolor, TEXT_ALIGN_RIGHT)
		draw.SimpleText(" + ", "ChatFont", subx - texw, y, color_white, TEXT_ALIGN_RIGHT)
		local pw, ph = surface.GetTextSize(" + ")
		draw.SimpleText(death.left, "ChatFont", subx - texw - pw, y, death.leftcolor, TEXT_ALIGN_RIGHT)
	elseif death.left then
		draw.SimpleText(death.left, "ChatFont", x - w * 0.5 - 16, y, death.leftcolor, TEXT_ALIGN_RIGHT)
	end

	draw.SimpleText(death.right, "ChatFont", x + w * 0.5 + 16, y, death.rightcolor, TEXT_ALIGN_LEFT)

	return y + h
end

function GM:DrawDeathNotice(x, y)
	x = x * w
	y = y * ScrH()

	local done = true
	for k, Death in pairs(Deaths) do
		if RealTime() < Death.time then
			done = false

			y = DrawDeath(x, y, Death)
		end
	end

	if done then
		Deaths = {}
	end
end
